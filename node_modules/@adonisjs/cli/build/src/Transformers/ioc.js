"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function iocTransformer(ts, rcFile) {
    const autoloads = Object.keys(rcFile.autoloads);
    return (ctx) => {
        return (sourceFile) => {
            function visitor(node) {
                if (ts.isCallExpression(node)
                    && node.expression
                    && ts.isIdentifier(node.expression)
                    && node.expression.escapedText === 'require') {
                    const moduleName = node.arguments[0].text;
                    if (moduleName && moduleName.startsWith('@ioc:')) {
                        return ts.createCall(ts.createIdentifier(`global[Symbol.for('ioc.use')]`), undefined, [ts.createStringLiteral(moduleName.substr(5))]);
                    }
                    if (moduleName && autoloads.find((autoload) => moduleName.startsWith(`${autoload}/`))) {
                        return ts.createCall(ts.createIdentifier(`global[Symbol.for('ioc.use')]`), undefined, [ts.createStringLiteral(moduleName)]);
                    }
                }
                return ts.visitEachChild(node, visitor, ctx);
            }
            return ts.visitEachChild(sourceFile, visitor, ctx);
        };
    };
}
exports.iocTransformer = iocTransformer;
